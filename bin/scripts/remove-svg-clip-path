#!/usr/bin/env ruby

# Generated by ChatGPT

# remove_clip_paths.rb
# Usage:
#   ruby remove_clip_paths.rb input.svg [output.svg]
# If output omitted, script will overwrite input.svg and create input.svg.bak

require 'nokogiri'
require 'fileutils'

if ARGV.empty?
  puts "Usage: ruby #{__FILE__} input.svg [output.svg]"
  exit 1
end

input_path = ARGV[0]
output_path = ARGV[1] # may be nil

unless File.file?(input_path)
  STDERR.puts "Error: input file not found: #{input_path}"
  exit 2
end

svg_text = File.read(input_path)
doc = Nokogiri::XML(svg_text) { |cfg| cfg.noblanks }

# 1) Remove all <clipPath> elements (any namespace)
doc.xpath("//*[local-name() = 'clipPath']").each(&:remove)

# 2) Remove attributes named 'clip-path' or with vendor prefix like '-webkit-clip-path'
# Iterate all elements and check attributes
doc.traverse do |node|
  next unless node.element?
  # remove straight attribute names and namespaced variants
  node.attribute_nodes.each do |attr|
    attr_name = attr.node_name # includes prefix if any, e.g. "xlink:href"
    # match clip-path or -webkit-clip-path or any :clip-path
    if attr_name =~ /(?:^|:|-)(?:-webkit-)?clip-path$/
      node.remove_attribute(attr_name)
    end
  end

  # 3) Clean style attribute: remove clip-path declarations inside 'style'
  if node['style']
    s = node['style']
    # remove clip-path:...; (and -webkit-clip-path)
    s2 = s.gsub(/\s*(?:-webkit-)?clip-path\s*:\s*[^;]+;?/i, '')
    # collapse multiple semicolons/spaces
    s2 = s2.gsub(/;;+/, ';').strip
    s2 = s2.sub(/;+\z/, '') # remove trailing semicolon
    if s2.empty?
      node.remove_attribute('style')
    else
      node['style'] = s2
    end
  end
end

# 4) Clean <style> element contents (embedded CSS)
doc.xpath("//style").each do |style_node|
  next unless style_node.element? && style_node.children.size > 0
  css = style_node.text
  # remove clip-path and -webkit-clip-path property occurrences
  css2 = css.gsub(/(?:-webkit-)?clip-path\s*:\s*[^;}\n]+;?/i, '')
  # optional: remove empty rule bodies like ".foo { ; }" -> ".foo { }"
  css2 = css2.gsub(/\{\s*;\s*\}/, '{}')
  style_node.content = css2
end

# Write output
if output_path.nil?
  backup = input_path + ".bak"
  FileUtils.cp(input_path, backup)
  File.write(input_path, doc.to_xml(save_with: Nokogiri::XML::Node::SaveOptions::AS_XML))
  puts "Processed and overwritten #{input_path} (backup saved to #{backup})."
else
  File.write(output_path, doc.to_xml(save_with: Nokogiri::XML::Node::SaveOptions::AS_XML))
  puts "Processed and saved to #{output_path}."
end

